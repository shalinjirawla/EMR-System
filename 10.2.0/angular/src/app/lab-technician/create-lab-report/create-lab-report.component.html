<form #labReportForm="ngForm" (ngSubmit)="save()" class="lab-test-form">
  <abp-modal-header title="ðŸ§ª Create Lab Report" (onCloseClick)="bsModalRef.hide()"></abp-modal-header>
  <div class="modal-body scrollable-body">

    <!-- Patient Info Section -->
    <section class="form-section">
      <h4>ðŸ‘¤ Patient Info</h4>

      <div class="mb-3">
        <label class="form-label">Select Patient</label>
        <p-dropdown [(ngModel)]="selectedPatientId" [options]="patients" optionLabel="fullName" optionValue="id"
          placeholder="Choose patient" name="patientId" class="w-100" (onChange)="onPatientChange($event.value)"
          required>
        </p-dropdown>
      </div>

      <div *ngIf="selectedPatient && !isAdmitted" class="mb-2">
  <label class="form-label d-block">Payment Mode</label>
  <div class="btn-group" role="group">
    <button type="button"
            pButton
            label="Cash"
            icon="pi pi-wallet"
            [class]="paymentMode === 0 ? 'p-button-success' : 'p-button-outlined'"
            (click)="paymentMode = 0">
    </button>
    <button type="button"
            pButton
            label="Card"
            icon="pi pi-credit-card"
            [class]="paymentMode === 1 ? 'p-button-success' : 'p-button-outlined'"
            (click)="paymentMode = 1">
    </button>
  </div>
</div>

    </section>

    <!-- Lab Test Section -->
    <section class="form-section">
      <h4>ðŸ§ª Lab Test</h4>
      <div class="mb-3">
        <label class="form-label">Select Lab Test</label>
        <p-dropdown [(ngModel)]="selectedLabTestId" [options]="labTests" optionLabel="reportType" optionValue="id"
          placeholder="Choose Lab Test" name="labTestId" class="w-100" (onChange)="onLabTestChange($event.value)"
          required>
        </p-dropdown>
      </div>
    </section>

    <!-- Test Items -->
    <section *ngIf="items.length" class="form-section test-items">

      <!-- Desktop View -->
      <div class="d-none d-md-block">
        <div class="table-header">
          <div>Test</div>
          <div>Unit</div>
          <div>Min</div>
          <div>Max</div>
          <div>Result</div>
          <div>Flag</div>
        </div>

        <div *ngFor="let item of items; let i = index" class="table-row" [ngClass]="{ 'abnormal': isAbnormal(item) }">
          <div><b>{{ item.labTestName }}</b></div>
          <div>
            <div>{{ item.measureUnitName }}</div>
          </div>
          <div>{{ item.minRange }}</div>
          <div>{{ item.maxRange }}</div>
          <input type="text" pInputText [(ngModel)]="item.result" [name]="'itemResult' + i"
            (ngModelChange)="onResultChange(item)" placeholder="Result" />
          <div>
            <p-tag [severity]="getSeverity(item.flag)" [value]="item.flag || 'Unset'"></p-tag>
          </div>
        </div>
      </div>

      <!-- Mobile View -->
      <div class="d-md-none">
        <div *ngFor="let item of items; let i = index" class="mobile-card">
          <div class="mobile-header">{{ item.labTestName }}</div>

          <div class="mobile-row">
            <label>Result</label>
            <input type="text" pInputText [(ngModel)]="item.result" [name]="'itemResult' + i"
              (ngModelChange)="onResultChange(item)" placeholder="Enter result"  />
          </div>

          <div class="mobile-row pair">
            <div class="pair-cell">
              <label>Min</label>
              <span>{{ item.minRange }}</span>
            </div>
            <div class="pair-cell">
              <label>Max</label>
              <span>{{ item.maxRange }}</span>
            </div>
          </div>

          <div class="mobile-row pair">
            <div class="pair-cell">
              <label>Unit</label>
              <span>{{ item.measureUnitName }}</span>
            </div>
            <div class="pair-cell">
              <label>Flag</label>
              <p-tag [severity]="getSeverity(item.flag)" [rounded]="true" [value]="item.flag || 'Unset'"></p-tag>
            </div>
          </div>
        </div>
      </div>

    </section>
  </div>

  <abp-modal-footer (onCancelClick)="bsModalRef.hide()" [saveDisabled]="saving">
    <button pButton type="submit" label="Save" icon="pi pi-check" [disabled]="saving"></button>
    <button pButton type="button" label="Cancel" icon="pi pi-times" class="ml-2" (click)="bsModalRef.hide()"
      [disabled]="saving"></button>
  </abp-modal-footer>
</form>